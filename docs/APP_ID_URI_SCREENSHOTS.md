# アプリケーション ID URI 設定スクリーンショットガイド

このドキュメントでは、Azure Portalでアプリケーション ID URIを設定する手順を、画面の説明付きで解説します。

---

## 全体の流れ

```
1. App Registrationを開く
   ↓
2. 左メニュー「APIの公開」をクリック
   ↓
3. 「追加」ボタンをクリック
   ↓
4. デフォルト値を確認
   ↓
5. api://botid-{APP_ID} に変更
   ↓
6. 保存
   ↓
7. 完了
```

---

## 詳細手順（画面説明付き）

### 画面1: App Registrationの概要ページ

Azure Portal で App Registration を開いたときの初期画面:

```
┌─────────────────────────────────────────────────────────┐
│ teams-leave-bot                              [削除] [×] │
├─────────────────────────────────────────────────────────┤
│ 🏠 概要                                                  │
│                                                          │
│  表示名                                                  │
│  teams-leave-bot                                        │
│                                                          │
│  アプリケーション (クライアント) ID                      │
│  12345678-1234-1234-1234-123456789abc    📋 コピー     │
│                                                          │
│  ディレクトリ (テナント) ID                              │
│  aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa    📋 コピー     │
│                                                          │
│  サポートされているアカウントの種類                       │
│  任意の組織ディレクトリ内のアカウント (マルチテナント)    │
└─────────────────────────────────────────────────────────┘
```

**ここで確認:**
- ✅ アプリケーション (クライアント) ID をメモ
- ✅ サポートされているアカウントの種類が「マルチテナント」

---

### 画面2: 左メニュー

```
┌─────────────────────────┐
│ 管理                    │
├─────────────────────────┤
│ 🏠 概要                 │
│ 🚀 クイック スタート    │
│ 🔧 ブランド             │
│ 🔐 認証                 │
│ 🔑 証明書とシークレット │
│ 📡 APIの公開           │ ← ★ ここをクリック
│ 🔓 APIのアクセス許可    │
│ 👥 所有者               │
│ 📋 ロールと管理者       │
│ 📊 マニフェスト         │
└─────────────────────────┘
```

**「APIの公開」をクリック**

---

### 画面3: APIの公開ページ（初期状態）

アプリケーションID URIが未設定の場合:

```
┌───────────────────────────────────────────────────────────┐
│ teams-leave-bot > APIの公開                               │
├───────────────────────────────────────────────────────────┤
│                                                            │
│ アプリケーション ID URI                                    │
│ ┌────────────────────────────────────────────────────┐   │
│ │ 未定義                                             │   │
│ │                                            [追加]  │   │
│ └────────────────────────────────────────────────────┘   │
│                                                            │
│ ⓘ アプリケーションID URIは、APIを一意に識別するために     │
│   使用されます。                                           │
│                                                            │
│ このアプリケーションによって定義されるスコープ               │
│ ┌────────────────────────────────────────────────────┐   │
│ │ スコープが定義されていません                        │   │
│ └────────────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────────────┘
```

**「追加」ボタンをクリック**

---

### 画面4: アプリケーションID URIの追加ダイアログ

```
┌─────────────────────────────────────────────────────┐
│ アプリケーション ID URI を設定する            [×]   │
├─────────────────────────────────────────────────────┤
│                                                      │
│ アプリケーション ID URI                              │
│ ┌──────────────────────────────────────────────┐   │
│ │ api://12345678-1234-1234-1234-123456789abc   │   │
│ └──────────────────────────────────────────────┘   │
│                                                      │
│ ⓘ 推奨: api://{clientId} または                     │
│   api://{tenantId}/{clientId}                       │
│                                                      │
│              [キャンセル]      [保存]               │
└─────────────────────────────────────────────────────┘
```

**⚠️ ここが重要！**

デフォルトで表示される値:
```
api://12345678-1234-1234-1234-123456789abc
```

**これを以下に変更:**
```
api://botid-12345678-1234-1234-1234-123456789abc
        ↑
    botid- を追加（ハイフン忘れずに）
```

---

### 画面5: 変更後のダイアログ

```
┌─────────────────────────────────────────────────────┐
│ アプリケーション ID URI を設定する            [×]   │
├─────────────────────────────────────────────────────┤
│                                                      │
│ アプリケーション ID URI                              │
│ ┌──────────────────────────────────────────────┐   │
│ │ api://botid-12345678-1234-1234-1234-12345... │   │
│ └──────────────────────────────────────────────┘   │
│   ↑                                                 │
│   botid- を追加した                                 │
│                                                      │
│              [キャンセル]      [保存]  ← クリック   │
└─────────────────────────────────────────────────────┘
```

**「保存」ボタンをクリック**

---

### 画面6: 設定完了後

```
┌───────────────────────────────────────────────────────────┐
│ teams-leave-bot > APIの公開                               │
├───────────────────────────────────────────────────────────┤
│                                                            │
│ アプリケーション ID URI                                    │
│ ┌────────────────────────────────────────────────────┐   │
│ │ api://botid-12345678-1234-1234-1234-123456789abc  │   │
│ │                                            [編集]  │   │
│ └────────────────────────────────────────────────────┘   │
│                                                            │
│ ✅ 設定完了！                                              │
│                                                            │
│ このアプリケーションによって定義されるスコープ               │
│ ┌────────────────────────────────────────────────────┐   │
│ │ + スコープの追加                                    │   │
│ └────────────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────────────┘
```

**確認ポイント:**
- ✅ `api://botid-{APP_ID}` 形式になっている
- ✅ `botid-` のハイフンがある
- ✅ Application IDと一致している

---

## 実際の操作フロー（キーボード操作含む）

### 方法1: マウス操作

```
1. Azure Portal を開く
   https://portal.azure.com

2. 検索バーに「Microsoft Entra ID」と入力
   [Enter]

3. 左メニューから「アプリの登録」をクリック

4. 作成したアプリ（teams-leave-bot）をクリック

5. 左メニューから「APIの公開」をクリック

6. 「追加」ボタンをクリック

7. テキストボックスをクリック
   デフォルト値が表示される:
   api://12345678-1234-1234-1234-123456789abc

8. カーソルを api:// と 12345678 の間に移動
   [Home]キーまたは左矢印キーで移動

9. 「botid-」を入力
   結果: api://botid-12345678-1234-1234-1234-123456789abc

10. 「保存」ボタンをクリック

11. 完了！
```

### 方法2: コピー&ペースト（推奨）

```
1. App Registrationの概要ページで
   Application (client) IDをコピー
   例: 12345678-1234-1234-1234-123456789abc

2. テキストエディタ（メモ帳など）に貼り付け

3. 前に「api://botid-」を追加
   api://botid-12345678-1234-1234-1234-123456789abc

4. 完成した文字列をコピー

5. Azure Portalの「APIの公開」→「追加」

6. テキストボックスに貼り付け

7. 「保存」をクリック
```

**この方法のメリット:**
- ✅ タイプミスを防げる
- ✅ IDを正確にコピーできる
- ✅ 確認が簡単

---

## 検証方法

### PowerShellで確認（オプション）

Azure CLIを使って設定を確認できます:

```powershell
# Azure CLIでログイン
az login

# App Registrationの詳細を取得
az ad app show --id 12345678-1234-1234-1234-123456789abc

# identifierUrisを確認
# 出力例:
# "identifierUris": [
#   "api://botid-12345678-1234-1234-1234-123456789abc"
# ]
```

### Azure Portalで確認

```
App Registration → APIの公開

表示されている値:
api://botid-12345678-1234-1234-1234-123456789abc

✓ api:// で始まっている
✓ botid- がある（ハイフン付き）
✓ Application IDと一致
```

---

## トラブルシューティング（画面別）

### 問題1: 「追加」ボタンが表示されない

**画面:**
```
アプリケーション ID URI
既に設定されています: api://12345678-...
                       [編集]
```

**原因:**
既に設定済み

**解決方法:**
「編集」ボタンをクリックして変更

---

### 問題2: 保存時にエラーが出る

**画面:**
```
❌ アプリケーション ID URI は有効ではありません
```

**よくある間違い:**
```
❌ api://botid12345678-1234-... (ハイフンがない)
❌ api://bot-id-12345678-1234-... (余計なハイフン)
❌ https://botid-12345678-1234-... (httpsになっている)
❌ api://botid-wrong-id (IDが間違っている)
```

**正しい形式:**
```
✅ api://botid-12345678-1234-1234-1234-123456789abc
```

---

### 問題3: どのIDを使えばいいかわからない

**確認画面:**
```
App Registration > 概要

アプリケーション (クライアント) ID    ← これを使用
12345678-1234-1234-1234-123456789abc

オブジェクト ID                       ← 使用しない
xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

ディレクトリ (テナント) ID            ← 使用しない
yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy
```

**使用するID:**
アプリケーション (クライアント) ID のみ

---

## まとめ

### 設定前後の比較

**設定前:**
```
┌────────────────────────────┐
│ アプリケーション ID URI    │
│ 未定義                     │
│           [追加]           │
└────────────────────────────┘
```

**設定後:**
```
┌──────────────────────────────────────────┐
│ アプリケーション ID URI                  │
│ api://botid-12345678-1234-1234-1234-... │
│                               [編集]     │
└──────────────────────────────────────────┘
```

### チェックリスト

設定完了後、以下を確認:

- [ ] 「APIの公開」ページを開いた
- [ ] アプリケーションID URIが設定されている
- [ ] `api://` で始まっている
- [ ] `botid-` プレフィックスがある（ハイフン付き）
- [ ] その後のIDがApplication (client) IDと完全一致
- [ ] 保存済み
- [ ] 編集ボタンが表示されている（未定義ではない）

すべてチェックできたら、Botの設定に進めます！

---

## 次のステップ

1. ✅ アプリケーション ID URI 設定完了
2. 次: Azure Botリソースの作成
   → [AZURE_SETUP_MULTITENANT.md](../AZURE_SETUP_MULTITENANT.md) に戻る

---

**参考ドキュメント:**
- [APP_ID_URI_EXPLAINED.md](APP_ID_URI_EXPLAINED.md) - 詳細な技術解説

**最終更新**: 2025-01-10
